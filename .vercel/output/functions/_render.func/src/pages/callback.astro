---
import Layout from '../layouts/Layout.astro';
import { getAccessTokenFromCode } from '../lib/hubspot/api';

let message = '';

if (Astro.request.method === 'GET') {
    const url = new URL(Astro.request.url);
    const code = url.searchParams.get('code');

    if (code) {
        try {
            const { accessToken, portalId } = await getAccessTokenFromCode(code);
            // Store the access token and portal ID in cookies
            Astro.cookies.set('hubspot_access_token', accessToken, {
                path: '/',
                httpOnly: true,
                secure: true,
                sameSite: 'strict',
                maxAge: 60 * 60 * 2 // 2 hours
            });
            Astro.cookies.set('hubspot_portal_id', portalId, {
                path: '/',
                httpOnly: true,
                secure: true,
                sameSite: 'strict',
                maxAge: 60 * 60 * 2 // 2 hours
            });
            return Astro.redirect('/pages');
        } catch (error) {
            message = `Authentication failed: ${error.message}`;
        }
    } else {
        message = 'No authorization code received.';
    }
}
---

<Layout title="HubSpot OAuth Callback">
	<main>
		<h1>HubSpot OAuth Callback</h1>
		<p>{message}</p>
		<a href="/" class="button">Back to Home</a>
	</main>
</Layout>

<style>
	main {
		margin: auto;
		padding: 1rem;
		width: 800px;
		max-width: calc(100% - 2rem);
		color: white;
		font-size: 20px;
		line-height: 1.6;
	}
	.button {
		display: inline-block;
		padding: 10px 20px;
		background-color: #ff7a59;
		color: white;
		text-decoration: none;
		border-radius: 5px;
		font-weight: bold;
	}
</style>