---
export const prerender = false;
import Layout from '../layouts/Layout.astro';
import PageTree from '../components/PageTree.astro';
import { getSitePages } from '../lib/api/hubspot';
import { checkAuth } from '../lib/middleware/auth';
import cache, { CacheType } from '../lib/utils/cache';

let pages = [];
let error = '';

const { accessToken, refreshToken, isAuthenticated } = await checkAuth(Astro.cookies);

if (!isAuthenticated) {
    return Astro.redirect('/?error=missing_credentials');
}

const isArchived = Astro.url.searchParams.has('archived');

try {
    // Try to get data from cache first
    pages = cache.get(CacheType.PAGES, accessToken, { archived: isArchived }) || [];

    // If not in cache, fetch from API
    if (pages.length === 0) {
        pages = await getSitePages(accessToken, isArchived, refreshToken);
        cache.set(CacheType.PAGES, accessToken, pages, { archived: isArchived });
    }
} catch (err) {
    console.error('Error fetching pages:', err);
    error = `Failed to fetch pages: ${err instanceof Error ? err.message : 'Unknown error'}`;
}
---

<Layout title="HubSpot Site Pages">
    <meta name="access-token" content={accessToken} />
    <main class="container mx-auto max-w-4xl px-4 py-8">

        <h1 class="text-4xl font-bold mb-4 text-blue-200">HubSpot Site Pages <span class="text-xl text-blue-500">({pages.length} pages)</span></h1>
        
        { Astro.url.searchParams.has('archived') ? (
            <a href="/pages" class="text-blue-400 hover:text-blue-300 mb-8 block">Hide archived pages</a>
        ) : (
            <a href="/pages?archived=true" class="text-blue-400 hover:text-blue-300 mb-8 block">Show archived pages</a>
        )}
        
        {error && <p class="text-red-500 mb-6 p-4 bg-red-100 rounded-lg">{error}</p>}

        {pages.length === 0 ? (
            <p class="text-gray-400 text-xl">No pages found. {error ? 'An error occurred while fetching pages.' : ''}</p>
        ) : (
            <PageTree pages={pages} />
        )}

        <a href="/" class="inline-block mt-8 bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded transition duration-300">Back to Home</a>
    </main>
</Layout>